"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[647],{8453:(n,e,i)=>{i.d(e,{R:()=>s,x:()=>r});var t=i(6540);const o={},a=t.createContext(o);function s(n){const e=t.useContext(a);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:s(n.components),t.createElement(a.Provider,{value:e},n.children)}},9844:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>s,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"tutorial-basics/codigo-software","title":"C\xf3digo Desenvolvido","description":"C\xf3digo completo do projeto criado no Wokwi:","source":"@site/docs/tutorial-basics/codigo-software.md","sourceDirName":"tutorial-basics","slug":"/tutorial-basics/codigo-software","permalink":"/projeto-iot-caixa-medicamentos/docs/tutorial-basics/codigo-software","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Passo a Passo do Funcionamento","permalink":"/projeto-iot-caixa-medicamentos/docs/tutorial-basics/passo-a-passo"},"next":{"title":"Comunica\xe7\xe3o e Protocolos","permalink":"/projeto-iot-caixa-medicamentos/docs/tutorial-basics/comunicacao-protocolos"}}');var o=i(4848),a=i(8453);const s={sidebar_position:2},r="C\xf3digo Desenvolvido",l={},d=[];function c(n){const e={code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,a.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.header,{children:(0,o.jsx)(e.h1,{id:"c\xf3digo-desenvolvido",children:"C\xf3digo Desenvolvido"})}),"\n",(0,o.jsx)(e.p,{children:"C\xf3digo completo do projeto criado no Wokwi:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-js",metastring:'title="sketch.ino"',children:'#include <Wire.h>\n#include <WiFi.h>\n#include <PubSubClient.h>\n#include <ESP32Servo.h>\n#include "HX711.h"\n#include <Adafruit_GFX.h>\n#include <Adafruit_SSD1306.h>\n\n// --- CONFIGURA\xc7\xc3O REDE / MQTT ---\nconst char* ssid = "Wokwi-GUEST";\nconst char* password = "";\nconst char* mqtt_server = "broker.hivemq.com";\n\n// --- OLED ---\n#define SCREEN_WIDTH 128\n#define SCREEN_HEIGHT 64\nAdafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);\n\n// --- HX711 (pinos usados no projeto) ---\n#define DT 18\n#define SCK 19\nHX711 scale;\nfloat calibration_factor = 7050.0; \n\n// --- Servo ---\n#define SERVO_PIN 5\nServo myservo;\n\n// --- MQTT ---\nWiFiClient espClient;\nPubSubClient client(espClient);\nconst char* topic_event = "medbox/medbox01/events";\nconst char* topic_cmd   = "medbox/medbox01/cmd";\n\n// --- L\xf3gica de detec\xe7\xe3o ---\nfloat lastWeight = 0.0;             \nconst float thresholdIncrease = 0.05; \n\n// Sensibilidade principal: m\xednima queda (em gramas) para considerar "retirada"\nconst float minDrop = 0.02; \n\n// debounce temporal entre eventos (hold-off)\nconst unsigned long eventHoldoff = 2000; \n\nunsigned long lastEventMillis = 0; \n\n// filtro EMA\nfloat weightEma = 0.0;\n\nfloat emaAlpha = 0.6; \n\nbool handlingEvent = false; \n\n// --- utilit\xe1rios ---\nvoid showMsg(const char* msg) {\n  display.clearDisplay();\n  display.setTextSize(1);\n  display.setCursor(0,0);\n  display.setTextColor(SSD1306_WHITE);\n  display.println(msg);\n  display.display();\n}\n\nvoid callback(char* topic, byte* payload, unsigned int length) {\n  String msg;\n  for (unsigned int i = 0; i < length; i++) msg += (char)payload[i];\n  Serial.print("[MQTT Rx] "); Serial.print(topic); Serial.print(" -> "); Serial.println(msg);\n  if (String(topic) == topic_cmd) {\n    if (msg == "open") {\n      myservo.write(90);\n      showMsg("Caixa aberta (cmd)");\n    } else if (msg == "close") {\n      myservo.write(0);\n      showMsg("Caixa fechada (cmd)");\n    }\n  }\n}\n\nvoid reconnect() {\n  static unsigned long lastTry = 0;\n  if (millis() - lastTry < 2000) return;\n  lastTry = millis();\n  Serial.println("Tentando conectar MQTT...");\n  if (client.connect("medbox01_sim")) {\n    Serial.println("MQTT conectado");\n    client.subscribe(topic_cmd);\n    // n\xe3o sobrescrever display\n  } else {\n    Serial.print("MQTT falhou, rc="); Serial.println(client.state());\n  }\n}\n\nvoid publishEvent(const char* ev) {\n  char payload[128];\n  snprintf(payload, sizeof(payload), "{\\"device\\":\\"medbox01\\",\\"event\\":\\"%s\\",\\"ts\\":%lu}", ev, millis());\n  bool ok = client.publish(topic_event, payload);\n  Serial.print("[publish] "); Serial.print(payload); Serial.print(" -> "); Serial.println(ok?"OK":"FAIL");\n}\n\nvoid setup() {\n  Serial.begin(115200);\n  delay(50);\n  Serial.println("=== START: medbox HX711 prototype ===");\n\n  // I2C\n  Wire.begin(21, 22);\n  Serial.println("Wire.begin(21,22)");\n\n  // OLED\n  bool ok = display.begin(SSD1306_SWITCHCAPVCC, 0x3C);\n  Serial.print("display.begin returned: "); Serial.println(ok?"OK":"FAIL");\n  if (ok) {\n    showMsg("OLED inicializado");\n    delay(300);\n  }\n\n  // Servo\n  myservo.setPeriodHertz(50);\n  myservo.attach(SERVO_PIN, 500, 2400);\n  myservo.write(0);\n  Serial.println("Servo configurado");\n\n  // HX711\n  scale.begin(DT, SCK);\n  scale.set_scale(calibration_factor);\n  scale.tare();\n  delay(500);\n\n  // inicializa EMA com m\xe9dia de leituras\n  float initSum = 0.0;\n  const int initSamples = 10;\n  for (int i = 0; i < initSamples; ++i) {\n    if (scale.is_ready()) initSum += scale.get_units(3);\n    delay(50);\n  }\n  weightEma = initSum / initSamples;\n  lastWeight = weightEma;\n  Serial.print("Referencia inicial (lastWeight) = "); Serial.println(lastWeight, 4);\n\n  // WiFi\n  WiFi.begin(ssid, password);\n  unsigned long start = millis();\n  while (WiFi.status() != WL_CONNECTED && millis() - start < 8000) {\n    Serial.print(\'.\'); delay(200);\n  }\n  Serial.println();\n  if (WiFi.status() == WL_CONNECTED) {\n    Serial.println("WiFi conectado: " + WiFi.localIP().toString());\n    showMsg("WiFi conectado");\n  } else {\n    Serial.println("WiFi nao conectado (simulador)");\n    showMsg("WiFi offline");\n  }\n\n  // MQTT\n  client.setServer(mqtt_server, 1883);\n  client.setCallback(callback);\n\n  lastEventMillis = 0;\n}\n\nvoid triggerMedicationEvent() {\n  handlingEvent = true;\n  lastEventMillis = millis();\n\n  Serial.println("[Evento] queda confirmada -> acionando servo e publicando");\n  showMsg("Remedio retirado!");\n  myservo.write(90);\n  delay(800);\n  myservo.write(0);\n  publishEvent("taken");\n\n  // Atualiza baseline para evitar retrigger imediato\n  lastWeight = weightEma;\n\n  Serial.print("Nova referencia lastWeight = "); Serial.println(lastWeight, 4);\n\n  handlingEvent = false;\n}\n\nvoid loop() {\n  if (WiFi.status() == WL_CONNECTED && !client.connected()) reconnect();\n  if (WiFi.status() == WL_CONNECTED) client.loop();\n\n  float reading = 0.0;\n  if (scale.is_ready()) {\n    reading = scale.get_units();\n    reading += ((float)random(-3, 3)) / 100.0; \n  }\n\n  // filtro EMA\n  weightEma = (emaAlpha * reading) + ((1.0 - emaAlpha) * weightEma);\n\n  float diff = weightEma - lastWeight;\n  unsigned long now = millis();\n\n  Serial.print("[Reading] "); Serial.print(reading, 2);\n  Serial.print("  [EMA] "); Serial.print(weightEma, 2);\n  Serial.print("  [Ref] "); Serial.print(lastWeight, 2);\n  Serial.print("  [Diff] "); Serial.println(diff, 2);\n\n  // >>> disparo de evento quando o peso diminui (retirada)\n  if (!handlingEvent && (diff <= -minDrop) && (now - lastEventMillis > eventHoldoff)) {\n    triggerMedicationEvent();\n  }\n\n  // >>> atualiza baseline se houver aumento percept\xedvel de peso\n  if (diff >= thresholdIncrease) {\n    Serial.println("Peso aumentado: atualizando baseline");\n    lastWeight = weightEma;\n  }\n\n  delay(300);\n}\n'})}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-json",metastring:'title="diagram.json"',children:'{\n  "version": 1,\n  "author": "Anonymous maker",\n  "editor": "wokwi",\n  "parts": [\n    { "type": "board-esp32-devkit-c-v4", "id": "esp", "top": -9.6, "left": 24.04, "attrs": {} },\n    {\n      "type": "board-ssd1306",\n      "id": "oled1",\n      "top": -73.66,\n      "left": 19.43,\n      "attrs": { "i2cAddress": "0x3c" }\n    },\n    { "type": "wokwi-servo", "id": "servo1", "top": 46, "left": 172.8, "attrs": {} },\n    {\n      "type": "wokwi-hx711",\n      "id": "cell1",\n      "top": -74.2,\n      "left": 165.8,\n      "attrs": { "type": "5kg" }\n    }\n  ],\n  "connections": [\n    [ "esp:TX", "$serialMonitor:RX", "", [] ],\n    [ "esp:RX", "$serialMonitor:TX", "", [] ],\n    [ "servo1:V+", "esp:5V", "red", [ "h0" ] ],\n    [ "servo1:GND", "esp:GND.1", "#8f4814", [ "h0" ] ],\n    [ "oled1:VCC", "esp:3V3", "white", [ "v0" ] ],\n    [ "oled1:GND", "esp:GND.3", "violet", [ "v0" ] ],\n    [ "servo1:PWM", "esp:5", "orange", [ "h0" ] ],\n    [ "oled1:SDA", "esp:21", "blue", [ "v0" ] ],\n    [ "oled1:SCL", "esp:22", "purple", [ "v0" ] ],\n    [ "cell1:DT", "esp:18", "green", [ "h0" ] ],\n    [ "cell1:SCK", "esp:19", "green", [ "h0" ] ],\n    [ "cell1:VCC", "esp:3V3", "red", [ "h0" ] ],\n    [ "cell1:GND", "esp:GND.2", "black", [ "h0" ] ]\n  ],\n  "dependencies": {}\n}\n'})})]})}function p(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,o.jsx)(e,{...n,children:(0,o.jsx)(c,{...n})}):c(n)}}}]);